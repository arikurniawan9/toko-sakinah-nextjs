
// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  name         String
  username     String   @unique
  employeeNumber String?  @unique // Nomor pegawai
  password     String   // hashed password
  role         String   // ADMIN, CASHIER, ATTENDANT
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt()

  cashierSales   Sale[] @relation("CashierSales")
  attendantSales Sale[] @relation("AttendantSales")
  tempCarts      TempCart[] @relation("AttendantTempCarts")
  purchases      Purchase[] @relation("PurchaseUser")
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt()

  products Product[]
}

model Product {
  id             String   @id @default(cuid())
  categoryId     String
  name           String
  productCode    String   @unique
  stock          Int      @default(0)
  purchasePrice  Int      // harga beli
  supplierId     String
  image          String?
  description    String? // Add description field back
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt()

  category Category @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  supplier Supplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  salesDetails SaleDetail[]
  tempCarts TempCart[]
  priceTiers PriceTier[]
  purchaseItems PurchaseItem[] // Added missing back-relation
}

model PriceTier {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  minQty    Int
  maxQty    Int?
  price     Int

  @@unique([productId, minQty])
}

model Supplier {
  id        String   @id @default(cuid())
  name      String   @unique
  address   String?
  phone     String?
  email     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt()

  products Product[]
  purchases Purchase[]
}

model Member {
  id            String   @id @default(cuid())
  name          String
  phone         String   @unique
  address       String?
  membershipType String   // SILVER, GOLD, PLATINUM
  discount      Int      // in percentage
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt()

  sales Sale[]
}

model Sale {
  id          String   @id @default(cuid())
  cashierId   String
  attendantId String?
  memberId    String?
  date        DateTime @default(now())
  total       Int      // total sebelum diskon member
  discount    Int      // diskon member
  additionalDiscount Int @default(0) // Diskon tambahan manual
  tax         Int      // pajak opsional
  payment     Int      // jumlah yang dibayar
  change      Int      // kembalian
  createdAt   DateTime @default(now())

  cashier    User     @relation("CashierSales", fields: [cashierId], references: [id], onDelete: Restrict)
  attendant  User?    @relation("AttendantSales", fields: [attendantId], references: [id], onDelete: Restrict)
  member     Member?  @relation(fields: [memberId], references: [id], onDelete: Restrict)
  saleDetails SaleDetail[]
}

model SaleDetail {
  id         String @id @default(cuid())
  saleId     String
  productId  String
  quantity   Int
  price      Int      // harga satuan
  discount   Int      // potongan per item
  subtotal   Int      // total setelah potongan per item sebelum diskon member

  sale    Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Restrict)
}

model TempCart {
  id         String   @id @default(cuid())
  attendantId String
  productId  String
  quantity   Int      @default(1)
  createdAt  DateTime @default(now())

  attendant User    @relation("AttendantTempCarts", fields: [attendantId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id], onDelete: Restrict)
}

model Purchase {
  id           String     @id @default(cuid())
  supplierId   String
  userId       String     // User who made the purchase (e.g., Admin)
  purchaseDate DateTime   @default(now())
  totalAmount  Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt()

  supplier     Supplier   @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  user         User       @relation("PurchaseUser", fields: [userId], references: [id], onDelete: Restrict)
  items        PurchaseItem[]
}

model PurchaseItem {
  id            String   @id @default(cuid())
  purchaseId    String
  productId     String
  quantity      Int
  purchasePrice Int      // Price at which this specific item was purchased
  subtotal      Int      // quantity * purchasePrice

  purchase      Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product       Product  @relation(fields: [productId], references: [id], onDelete: Restrict)
}
