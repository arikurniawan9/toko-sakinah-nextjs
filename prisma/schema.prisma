generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                     String                  @id @default(cuid())
  name                   String
  username               String                  @unique
  employeeNumber         String?                 @unique
  code                   String?                 @unique
  gender                 String?
  address                String?
  phone                  String?
  email                  String?
  status                 String                  @default("AKTIF")
  password               String
  role                   String
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  auditLogs              AuditLog[]
  expenses               Expense[]
  purchases              Purchase[]              @relation("PurchaseUser")
  attendantSales         Sale[]                  @relation("AttendantSales")
  cashierSales           Sale[]                  @relation("CashierSales")
  storeUsers             StoreUser[]
  tempCarts              TempCart[]              @relation("AttendantTempCarts")
  warehouseDistributions WarehouseDistribution[] @relation("DistributionUser")
  notifications          Notification[]
}

model Category {
  id          String    @id @default(cuid())
  storeId     String
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  store       Store     @relation(fields: [storeId], references: [id])
  products    Product[]

  @@unique([name, storeId])
  @@index([storeId])
}

model Product {
  id                     String                  @id @default(cuid())
  storeId                String
  categoryId             String
  name                   String
  productCode            String
  stock                  Int                     @default(0)
  purchasePrice          Int
  retailPrice            Int                     // Harga eceran/pelanggan umum
  silverPrice            Int                     // Harga member silver
  goldPrice              Int                     // Harga member gold
  platinumPrice          Int                     // Harga member platinum/partai
  supplierId             String
  image                  String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  description            String?
  category               Category                @relation(fields: [categoryId], references: [id])
  store                  Store                   @relation(fields: [storeId], references: [id])
  supplier               Supplier                @relation(fields: [supplierId], references: [id])
  purchaseItems          PurchaseItem[]
  salesDetails           SaleDetail[]
  tempCarts              TempCart[]
  warehouseDistributions WarehouseDistribution[]
  WarehouseProduct       WarehouseProduct[]

  @@unique([productCode, storeId])
  @@index([storeId])
  @@index([categoryId])
  @@index([supplierId])
}


model Supplier {
  id            String     @id @default(cuid())
  storeId       String
  code          String
  name          String
  contactPerson String?
  address       String?
  phone         String?
  email         String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  products      Product[]
  purchases     Purchase[]
  store         Store      @relation(fields: [storeId], references: [id])

  @@unique([code, storeId])
  @@unique([name, storeId])
  @@index([storeId])
}

model Member {
  id             String       @id @default(cuid())
  storeId        String
  code           String
  name           String
  phone          String
  address        String?
  membershipType String       // SILVER, GOLD, PLATINUM (PLATINUM also means partai)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  store          Store        @relation(fields: [storeId], references: [id])
  receivables    Receivable[]
  sales          Sale[]
  suspendedSales SuspendedSale[]

  @@unique([phone, storeId])
  @@unique([code, storeId])
  @@index([storeId])
}

model Sale {
  id                 String       @id @default(cuid())
  storeId            String
  invoiceNumber      String
  cashierId          String
  attendantId        String?
  memberId           String?
  date               DateTime     @default(now())
  total              Int
  tax                Int
  payment            Int
  change             Int
  status             String       @default("PAID")
  createdAt          DateTime     @default(now())
  paymentMethod      String       @default("CASH")
  referenceNumber    String?
  receivable         Receivable?
  attendant          User?        @relation("AttendantSales", fields: [attendantId], references: [id], onDelete: Restrict)
  cashier            User         @relation("CashierSales", fields: [cashierId], references: [id])
  member             Member?      @relation(fields: [memberId], references: [id], onDelete: Restrict)
  store              Store        @relation(fields: [storeId], references: [id])
  saleDetails        SaleDetail[]

  @@unique([invoiceNumber, storeId])
  @@index([storeId])
  @@index([cashierId])
  @@index([attendantId])
  @@index([memberId])
  @@index([date])
}

model Receivable {
  id              String    @id @default(cuid())
  storeId         String
  saleId          String    @unique
  memberId        String
  amountDue       Int
  amountPaid      Int       @default(0)
  status          String
  dueDate         DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  referenceNumber String?
  member          Member    @relation(fields: [memberId], references: [id])
  sale            Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)
  store           Store     @relation(fields: [storeId], references: [id])

  @@index([storeId])
  @@index([memberId])
  @@index([saleId])
}

model SaleDetail {
  id        String  @id @default(cuid())
  storeId   String
  saleId    String
  productId String
  quantity  Int
  price     Int     // Harga satuan yang digunakan saat transaksi
  discount  Int     @default(0)
  subtotal  Int     // Jumlah subtotal (harga * jumlah - diskon)
  product   Product @relation(fields: [productId], references: [id])
  sale      Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)
  store     Store   @relation(fields: [storeId], references: [id])

  @@index([storeId])
  @@index([saleId])
  @@index([productId])
}

model TempCart {
  id          String   @id @default(cuid())
  storeId     String
  attendantId String
  productId   String
  quantity    Int      @default(1)
  createdAt   DateTime @default(now())
  attendant   User     @relation("AttendantTempCarts", fields: [attendantId], references: [id], onDelete: Cascade)
  product     Product  @relation(fields: [productId], references: [id])
  store       Store    @relation(fields: [storeId], references: [id])

  @@index([storeId])
  @@index([attendantId])
  @@index([productId])
}

model Purchase {
  id           String         @id @default(cuid())
  storeId      String
  supplierId   String
  userId       String
  purchaseDate DateTime       @default(now())
  totalAmount  Int
  status       String         @default("COMPLETED")
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  store        Store          @relation(fields: [storeId], references: [id])
  supplier     Supplier       @relation(fields: [supplierId], references: [id])
  user         User           @relation("PurchaseUser", fields: [userId], references: [id])
  items        PurchaseItem[]

  @@index([storeId])
  @@index([supplierId])
  @@index([userId])
  @@index([purchaseDate])
}

model PurchaseItem {
  id            String   @id @default(cuid())
  storeId       String
  purchaseId    String
  productId     String
  quantity      Int
  purchasePrice Int
  subtotal      Int
  product       Product  @relation(fields: [productId], references: [id])
  purchase      Purchase @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  store         Store    @relation(fields: [storeId], references: [id])

  @@index([storeId])
  @@index([purchaseId])
  @@index([productId])
}

model SuspendedSale {
  id                   String   @id @default(cuid())
  storeId              String
  name                 String?
  cartItems            String
  memberId             String?
  notes                String?
  additionalDiscount   Int?     @default(0)
  selectedAttendantId  String?
  createdAt            DateTime @default(now())
  store                Store    @relation(fields: [storeId], references: [id])
  member               Member?  @relation(fields: [memberId], references: [id])

  @@index([storeId])
}

model Setting {
  id         String   @id @default(cuid())
  storeId    String   @unique
  shopName   String?
  address    String?
  phone      String?
  themeColor String?  @default("#3c8dbc")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  store      Store    @relation(fields: [storeId], references: [id])

  @@index([storeId])
}

model AuditLog {
  id             String    @id @default(cuid())
  storeId        String
  userId         String?
  action         String
  entity         String
  entityId       String?
  oldValue       String?
  newValue       String?
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime  @default(now())
  additionalData Json?
  store          Store     @relation(fields: [storeId], references: [id])
  user           User?     @relation(fields: [userId], references: [id])

  @@index([storeId])
  @@index([userId])
  @@index([entity])
  @@index([createdAt])
}

model ExpenseCategory {
  id          String    @id @default(cuid())
  storeId     String
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  expenses    Expense[]
  store       Store     @relation(fields: [storeId], references: [id])

  @@unique([name, storeId])
  @@index([storeId])
}

model Expense {
  id                String          @id @default(cuid())
  storeId           String
  expenseCategoryId String
  amount            Int
  description       String?
  date              DateTime        @default(now())
  createdBy         String
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  user              User            @relation(fields: [createdBy], references: [id])
  category          ExpenseCategory @relation(fields: [expenseCategoryId], references: [id])
  store             Store           @relation(fields: [storeId], references: [id])

  @@index([storeId])
  @@index([expenseCategoryId])
  @@index([createdBy])
  @@index([date])
}

model Store {
  id                     String                  @id @default(cuid())
  code                   String                  @unique
  name                   String
  description            String?
  address                String?
  phone                  String?
  email                  String?
  status                 String                  @default("ACTIVE")
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  auditLogs              AuditLog[]
  categories             Category[]
  expenses               Expense[]
  expenseCategories      ExpenseCategory[]
  members                Member[]
  products               Product[]
  purchases              Purchase[]
  purchaseItems          PurchaseItem[]
  receivables            Receivable[]
  sales                  Sale[]
  saleDetails            SaleDetail[]
  settings               Setting?
  storeUsers             StoreUser[]
  suppliers              Supplier[]
  suspendedSales         SuspendedSale[]
  tempCarts              TempCart[]
  warehouseDistributions WarehouseDistribution[]
  notifications          Notification[]
}

model StoreUser {
  id         String   @id @default(cuid())
  userId     String
  storeId    String
  role       String
  status     String   @default("ACTIVE")
  assignedAt DateTime @default(now())
  assignedBy String?
  store      Store    @relation(fields: [storeId], references: [id])
  user       User     @relation(fields: [userId], references: [id])

  @@unique([userId, storeId])
  @@index([userId])
  @@index([storeId])
  @@index([role])
}

model Warehouse {
  id                     String                  @id @default(cuid())
  name                   String                  @unique @default("Gudang Pusat")
  description            String?
  address                String?
  phone                  String?
  status                 String                  @default("ACTIVE")
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  warehouseDistributions WarehouseDistribution[]
  warehouseProducts      WarehouseProduct[]
}

model WarehouseProduct {
  id          String    @id @default(cuid())
  productId   String
  warehouseId String
  quantity    Int       @default(0)
  reserved    Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  Product     Product   @relation(fields: [productId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([productId, warehouseId])
  @@index([warehouseId])
}

model WarehouseDistribution {
  id                String    @id @default(cuid())
  invoiceNumber     String?
  warehouseId       String
  storeId           String
  productId         String
  quantity          Int
  unitPrice         Int
  totalAmount       Int
  status            String    @default("DELIVERED")
  notes             String?
  distributedAt     DateTime  @default(now())
  distributedBy     String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  distributedByUser User      @relation("DistributionUser", fields: [distributedBy], references: [id])
  product           Product   @relation(fields: [productId], references: [id])
  store             Store     @relation(fields: [storeId], references: [id])
  warehouse         Warehouse @relation(fields: [warehouseId], references: [id])

  @@index([warehouseId])
  @@index([storeId])
  @@index([distributedBy])
  @@index([distributedAt])
  @@index([invoiceNumber])
}

// Model for Notifications
model Notification {
  id              String    @id @default(cuid())
  type            String
  title           String
  message         String
  userId          String?
  storeId         String?
  severity        String
  data            Json?
  acknowledged    Boolean   @default(false)
  acknowledgedAt  DateTime?
  createdAt       DateTime  @default(now())
  expiresAt       DateTime?

  // Relations
  user            User?     @relation(fields: [userId], references: [id])
  store           Store?    @relation(fields: [storeId], references: [id])

  @@index([userId])
  @@index([storeId])
  @@index([acknowledged])
  @@index([createdAt])
  @@index([expiresAt])
}
